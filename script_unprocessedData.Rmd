---
title: "MS data analysis"
author: "Maurits Evers"
date: "30/05/2017"
output: 
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    number_sections: true
    theme: united
    df_print: paged

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Prerequisities

We start by loading necessary R libraries.

```{r}
suppressMessages(library("readxl"));
suppressMessages(library("reshape2"));
suppressMessages(library("ggplot2"));
suppressMessages(library("ggrepel"));
suppressMessages(library("GGally"));
```


# The MS data

All MS data are stored in four Excel sheets, each of which contains the two sheets "processed full list" and "Unprocessed proteinGroups". 
```{r}
fn <- c("Exp2 sample 1.xlsx", "Exp2 sample 2.xlsx", "Exp3.xlsx", "Exp4.xlsx");
```

We load unprocessed data into a list of dataframes.
```{r}
data.list <- lapply(fn, function(x) as.data.frame(read_excel(x, sheet = 2)));
names(data.list) <- gsub(".xlsx", "", fn);
names(data.list) <- gsub(" ", "_", names(data.list));
```

As an example, we show data from `r fn[3]` in the following table:
```{r echo=FALSE}
head(data.list[[3]]);
```


# Data cleaning

From every dataframe in the list, we extract LFQ intensities for the GFP and Myc-tagged (MT) libraries
```{r}
data <- lapply(data.list, function(x) {
  df <- x[, c(1, 2, 17)];
  colnames(df) <- c("GFP", "MT", "proteinID");
  return(df);
})
```

and merge all dataframes from the list into one dataframe.
```{r}
data.merged <- Reduce(function(x,y) merge(x, y, by = "proteinID", all = TRUE), data);
# Give unique colnames
colnames(data.merged) <- c("proteinID", paste(rep(c("GFP", "MT"), 4), rep(names(data), each = 2), sep = "_"));
# Replace zeros with NA's
data.merged[data.merged == 0] <- NA;
```


# Replicate library consistency

We plot pairwise sample log2-transformed LFQ values, and show corresponding Pearson's product-moment correlation coefficients. Congruence between replicate libraries is reflected by large positive correlation coefficients. Dashed red lines indicate the identity map, and blue lines with blue shaded areas give the linear model fit including 95% confidence intervals. 

### GFP libraries
```{r echo=FALSE, fig.width = 8, fig.height = 6}
df <- log2(data.merged[, grep("GFP", colnames(data.merged))]);
# Remove entries that have only NA's
df <- df[!apply(df, 1, function(x) all(is.na(x))), ];
# Switch off warnings to get rid of annoying warning messages due to NA's
options(warn = -1);
# Pairwise plots
my_fn <- function(data, mapping, method = "lm", ...) {
  p <- ggplot(data = data, mapping = mapping);
  p <- p + geom_point();
  p <- p + geom_abline(slope = 1, intercept = 0, colour = "red", linetype = 3);
  p <- p + geom_smooth(method = method, fullrange = TRUE, ...);
  return(p);
}
gg <- ggpairs(df, lower = list(continuous = my_fn));
gg <- gg + theme_bw();
gg <- gg + theme(
  strip.background = element_blank(),
  panel.border = element_rect(colour = "black"),
  legend.position = "bottom",
  legend.key = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank()
);
gg <- gg + labs(
  x = "log2(LFQ, Sample 1)",
  y = "log2(LFQ, Sample 2)",
  title = "Correlation of pairwise sample LFQ values"
);
gg;
options(warn = 0);
```

### MT libraries
```{r echo=FALSE, fig.width = 8, fig.height = 6}
df <- log2(data.merged[, grep("MT", colnames(data.merged))]);
# Remove entries that have only NA's
df <- df[!apply(df, 1, function(x) all(is.na(x))), ];
# Switch off warnings to get rid of annoying warning messages due to NA's
options(warn = -1);
# Pairwise plots
my_fn <- function(data, mapping, method = "lm", ...) {
  p <- ggplot(data = data, mapping = mapping);
  p <- p + geom_point();
  p <- p + geom_abline(slope = 1, intercept = 0, colour = "red", linetype = 3);
  p <- p + geom_smooth(method = method, fullrange = TRUE, ...);
  return(p);
}
gg <- ggpairs(df, lower = list(continuous = my_fn));
gg <- gg + theme_bw();
gg <- gg + theme(
  strip.background = element_blank(),
  panel.border = element_rect(colour = "black"),
  legend.position = "bottom",
  legend.key = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank()
);
gg <- gg + labs(
  x = "log2(LFQ, Sample 1)",
  y = "log2(LFQ, Sample 2)",
  title = "Correlation of pairwise sample LFQ values"
);
gg;
options(warn = 0);
```


# GFP-corrected replicate library consistency

We calculate relative protein abundances as
$$
\text{relLog2LFQ} = \log_2(\text{LFQ, MT}) - \log_2(\text{LFQ, GFP})\,,
$$
and show pairwise comparisons.
```{r echo=FALSE, fig.width = 8, fig.height = 6}
df <- cbind.data.frame(
  log2(data.merged[, 3]) - log2(data.merged[, 2]),
  log2(data.merged[, 5]) - log2(data.merged[, 4]),
  log2(data.merged[, 7]) - log2(data.merged[, 6]),
  log2(data.merged[, 9]) - log2(data.merged[, 8]));
df <- df[!apply(df, 1, function(x) all(is.na(x))), ];
colnames(df) <- names(data.list);
# Switch off warnings to get rid of annoying warning messages due to NA's
options(warn = -1);
# Pairwise plots
gg <- ggpairs(df);
gg <- gg + theme_bw();
gg <- gg + theme(
  strip.background = element_blank(),
  panel.border = element_rect(colour = "black"),
  legend.position = "bottom",
  legend.key = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank()
);
gg <- gg + labs(
  x = "relLog2LFQ(Sample1)",
  y = "relLog2LFQ(Sample1)",
  title = "Correlation of pairwise sample relative (GFP-subtracted) LFQ values"
);
gg;
options(warn = 0);
```

# Analysis of all pairwise library comparisons

```{r echo=FALSE, fig.width = 12, fig.height = 12}
df <- log2(data.merged[, -1]);
# Remove entries that have only NA's
df <- df[!apply(df, 1, function(x) all(is.na(x))), ];
# Switch off warnings to get rid of annoying warning messages due to NA's
options(warn = -1);
# Pairwise plots
my_fn <- function(data, mapping, method = "lm", ...) {
  p <- ggplot(data = data, mapping = mapping);
  p <- p + geom_point();
  p <- p + geom_abline(slope = 1, intercept = 0, colour = "red", linetype = 3);
  p <- p + geom_smooth(method = method, fullrange = TRUE, ...);
  return(p);
}
gg <- ggpairs(df, lower = list(continuous = my_fn));
gg <- gg + theme_bw();
gg <- gg + theme(
  strip.background = element_blank(),
  panel.border = element_rect(colour = "black"),
  legend.position = "bottom",
  legend.key = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank()
);
gg <- gg + labs(
  x = "log2(LFQ, Sample 1)",
  y = "log2(LFQ, Sample 2)",
  title = "Correlation of pairwise sample LFQ values"
);
gg;
options(warn = 0);
```
